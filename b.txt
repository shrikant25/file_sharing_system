#include <stdio.h>
#include <stdlib.h>
#include <libpq-fe.h>

int main() {
    // Connect to the database
    PGconn* conn = PQconnectdb("host=localhost port=5432 dbname=mydb user=myuser password=mypassword");
    if (PQstatus(conn) != CONNECTION_OK) {
        printf("Error connecting to the database: %s\n", PQerrorMessage(conn));
        return 1;
    }

    // Execute the SELECT statement
    PGresult* res = PQexec(conn, "SELECT file_data FROM mytable1");
    if (PQresultStatus(res) != PGRES_TUPLES_OK) {
        printf("Error executing SELECT statement: %s\n", PQresultErrorMessage(res));
        PQclear(res);
        PQfinish(conn);
        return 1;
    }

    // Iterate over the result set
    for (int i = 0; i < PQntuples(res); i++) {
        // Get the binary data
        char* file_data = PQgetvalue(res, i, 0);
        int file_size = PQgetlength(res, i, 0);

        // Prepare the INSERT statement
        const char* sql = "INSERT INTO mytable2 (file_data) VALUES ($1)";
        PGresult* res_prepared = PQprepare(conn, "insert_binary", sql, 1, NULL);
        if (PQresultStatus(res_prepared) != PGRES_COMMAND_OK) {
            printf("Error preparing INSERT statement: %s\n", PQresultErrorMessage(res_prepared));
            PQclear(res_prepared);
            PQclear(res);
            PQfinish(conn);
            return 1;
        }
        PQclear(res_prepared);

        // Bind the binary data to the statement
        int param_formats[1] = {1};
        int param_lengths[1] = {file_size};
        const char* param_values[1] = {file_data};
        res_prepared = PQexecPrepared(conn, "insert_binary", 1, param_values, param_lengths, param_formats, 1);
        if (PQresultStatus(res_prepared) != PGRES_COMMAND_OK) {
            printf("Error executing INSERT statement: %s\n", PQresultErrorMessage(res_prepared));
            PQclear(res_prepared);
            PQclear(res);
            PQfinish(conn);
            return 1;
        }
        PQclear(res_prepared);
    }

    // Clear the result set
    PQclear(res);

    // Close the connection
    PQfinish(conn);
    return 0;
}

